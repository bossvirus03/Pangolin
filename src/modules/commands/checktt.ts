import * as cache from "memory-cache";
import Ifca from "src/types/type.api";
import IEvent from "src/types/type.event";
import { IUserInThreadData } from "src/types/type.userInThreadData";

export default class CheckttCommand {
  static config = {
    name: "checktt",
    version: "1.0.0",
    author: "Nguy√™n Blue | L·ª£i",
    createdAt: "",
    permission: 0,
    description: {
      vi: "Ki·ªÉm tra s·ªë l∆∞·ª£t th√†nh vi√™n t∆∞∆°ng t√°c c·ªßa b·∫°n trong nh√≥m",
      en: "Check the number of your interactions in the group",
    },
    guide: {
      vi: "[prefix]check",
      en: "[prefix]check",
    },
  };

  static message = {
    vi: {
      listInteract: "$0",
    },
    en: {
      listInteract: "$0",
    },
  };

  constructor(private client) {}

  async event(
    api: Ifca,
    event: IEvent,
    client,
    UserData,
    ThreadData,
    UserInThreadData: IUserInThreadData
  ) {
    if (event.type === "message_reaction") {
      const messageID = cache.get("message-id");
      if (messageID && event.reaction === "‚ù§") {
        api.getThreadInfo(event.threadID, async (err, res) => {
          if (err) {
            console.error("Error:", err);
            return;
          }

          const users = res.participantIDs;
          const smg = await Promise.all(
            users.map(async (item) => {
              try {
                const user = await UserInThreadData.get(item, event.threadID);
                if (user) {
                  return { name: user.name, exp: user.exp };
                }
              } catch (error) {
                console.error("Error:", error);
              }
            })
          );

          smg.sort((a, b) => b.exp - a.exp);
          let smgSorted = "";
          smg.forEach((user, index) => {
            if (user) {
              let medal = "";
              switch (index) {
                case 0:
                  medal = "ü•á";
                  break;
                case 1:
                  medal = "ü•à";
                  break;
                case 2:
                  medal = "ü•â";
                  break;
                default:
                  medal = ` ${index + 1}.`;
                  break;
              }
              smgSorted += `${medal} ${user.name} - ${user.exp}\n`;
            }
          });

          api.sendMessage('[ KI·ªÇM TRA TIN NH·∫ÆN T·ªîNG ]' + '\n' + smgSorted, event.threadID);
          cache.del("message-id");
        });
      }
    }
  }

  async run(
    api: Ifca,
    event: IEvent,
    client,
    args,
    UserData,
    ThreadData,
    UserInThreadData: IUserInThreadData,
    getLang
  ) {
    try {
      const user = event.senderID;
      const res = await UserInThreadData.get(user, event.threadID);

      //   const threadInfo = await api.getThreadInfo(event.threadID);
      const threadInfo: any = await new Promise((resolve, reject) => {
        api.getThreadInfo(event.threadID, (err, info) => {
          if (err) reject(err);
          else resolve(info);
        });
      });
      const listad = threadInfo.adminIDs.map((admin) => admin.id);

      const threadName = threadInfo.threadName;
      const position = listad.includes(res.uid)
        ? "Qu·∫£n tr·ªã vi√™n"
        : "Th√†nh vi√™n";

      let getRankName = (count) => {
        return count > 4440
          ? "B·∫•t Di·ªát Chi C·∫£nh"
          : count > 4040
            ? "S√°ng Th·∫ø C·∫£nh ƒê·ªânh Phong"
            : count > 3840
              ? "S√°ng Th·∫ø C·∫£nh H·∫≠u K√¨"
              : count > 3640
                ? "S√°ng Th·∫ø C·∫£nh Trung K√¨"
                : count > 3440
                  ? "S√°ng Th·∫ø C·∫£nh S∆° K√¨"
                  : count > 3240
                    ? "H·ª£p ƒê·∫°o C·∫£nh ƒê·ªânh Phong"
                    : count > 3040
                      ? "H·ª£p ƒê·∫°o C·∫£nh H·∫≠u K√¨"
                      : count > 2840
                        ? "H·ª£p ƒê·∫°o C·∫£nh Trung K√¨"
                        : count > 2640
                          ? "H·ª£p ƒê·∫°o C·∫£nh S∆° K√¨"
                          : count > 2440
                            ? "Th√°nh V∆∞∆°ng C·∫£nh ƒê·ªânh Phong"
                            : count > 2240
                              ? "Th√°nh V∆∞∆°ng C·∫£nh H·∫≠u K√¨"
                              : count > 2220
                                ? "Th√°nh V∆∞∆°ng C·∫£nh Trung K√¨"
                                : count > 2200
                                  ? "Th√°nh V∆∞∆°ng C·∫£nh S∆° K√¨"
                                  : count > 2180
                                    ? "Th√°nh C·∫£nh ƒê·ªânh Phong"
                                    : count > 2160
                                      ? "Th√°nh C·∫£nh H·∫≠u K√¨"
                                      : count > 2140
                                        ? "Th√°nh C·∫£nh Trung K√¨"
                                        : count > 2120
                                          ? "Th√°nh C·∫£nh S∆° K√¨"
                                          : count > 2100
                                            ? "Ch√≠ T√¥n ƒê·ªânh Phong"
                                            : count > 2080
                                              ? "Ch√≠ T√¥n H·∫≠u K√¨"
                                              : count > 2060
                                                ? "Ch√≠ T√¥n Trung K√¨"
                                                : count > 2040
                                                  ? "Ch√≠ T√¥n S∆° K√¨"
                                                  : count > 2020
                                                    ? "ƒê·∫°i Th√°nh ƒê·ªânh Phong"
                                                    : count > 2000
                                                      ? "ƒê·∫°i Th√°nh H·∫≠u K√¨"
                                                      : count > 1980
                                                        ? "ƒê·∫°i Th√°nh Trung K√¨"
                                                        : count > 1960
                                                          ? "ƒê·∫°i Th√°nh S∆° K√¨"
                                                          : count > 1940
                                                            ? "Ti·ªÉu Th√°nh ƒê·ªânh Phong"
                                                            : count > 1920
                                                              ? "Ti·ªÉu Th√°nh H·∫≠u K√¨"
                                                              : count > 1900
                                                                ? "Ti·ªÉu Th√°nh Trung K√¨"
                                                                : count > 1880
                                                                  ? "Ti·ªÉu Th√°nh S∆° K√¨"
                                                                  : count > 1860
                                                                    ? "ƒê·∫°o T·ªï ƒê·ªânh Phong"
                                                                    : count >
                                                                        1840
                                                                      ? "ƒê·∫°o T·ªï H·∫≠u K√¨"
                                                                      : count >
                                                                          1820
                                                                        ? "ƒê·∫°o T·ªï Trung K√¨"
                                                                        : count >
                                                                            1800
                                                                          ? "ƒê·∫°o T·ªï S∆° K√¨"
                                                                          : count >
                                                                              1780
                                                                            ? "ƒê·∫°o ƒê·∫ø ƒê·ªânh Phong"
                                                                            : count >
                                                                                1760
                                                                              ? "ƒê·∫°o ƒê·∫ø H·∫≠u K√¨"
                                                                              : count >
                                                                                  1740
                                                                                ? "ƒê·∫°o ƒê·∫ø Trung K√¨"
                                                                                : count >
                                                                                    1720
                                                                                  ? "ƒê·∫°o ƒê·∫ø S∆° K√¨"
                                                                                  : count >
                                                                                      1700
                                                                                    ? "ƒê·∫°o T√¥n ƒê·ªânh Phong"
                                                                                    : count >
                                                                                        1680
                                                                                      ? "ƒê·∫°o T√¥n H·∫≠u K√¨"
                                                                                      : count >
                                                                                          1660
                                                                                        ? "ƒê·∫°o T√¥n Trung K√¨"
                                                                                        : count >
                                                                                            1640
                                                                                          ? "ƒê·∫°o T√¥n S∆° K√¨"
                                                                                          : count >
                                                                                              1620
                                                                                            ? "Ti√™n ƒê·∫ø ƒê·ªânh Phong"
                                                                                            : count >
                                                                                                1600
                                                                                              ? "Ti√™n ƒê·∫ø H·∫≠u K√¨"
                                                                                              : count >
                                                                                                  1580
                                                                                                ? "Ti√™n ƒê·∫ø Trung K√¨"
                                                                                                : count >
                                                                                                    1560
                                                                                                  ? "Ti√™n ƒê·∫ø S∆° K√¨"
                                                                                                  : count >
                                                                                                      1540
                                                                                                    ? "Ti√™n T√¥n ƒê·ªânh Phong"
                                                                                                    : count >
                                                                                                        1520
                                                                                                      ? "Ti√™n T√¥n H·∫≠u K√¨"
                                                                                                      : count >
                                                                                                          1500
                                                                                                        ? "Ti√™n T√¥n Trung K√¨"
                                                                                                        : count >
                                                                                                            1480
                                                                                                          ? "Ti√™n T√¥n S∆° K√¨"
                                                                                                          : count >
                                                                                                              1460
                                                                                                            ? "Ti√™n V∆∞∆°ng ƒê·ªânh Phong"
                                                                                                            : count >
                                                                                                                1440
                                                                                                              ? "Ti√™n V∆∞∆°ng H·∫≠u K√¨"
                                                                                                              : count >
                                                                                                                  1420
                                                                                                                ? "Ti√™n V∆∞∆°ng Trung K√¨"
                                                                                                                : count >
                                                                                                                    1400
                                                                                                                  ? "Ti√™n V∆∞∆°ng S∆° K√¨"
                                                                                                                  : count >
                                                                                                                      1380
                                                                                                                    ? "ƒê·∫°i La Kim Ti√™n"
                                                                                                                    : count >
                                                                                                                        1360
                                                                                                                      ? "ƒê·∫°i La Ch√¢n Ti√™n"
                                                                                                                      : count >
                                                                                                                          1340
                                                                                                                        ? "ƒê·∫°i La T√°n Ti√™n"
                                                                                                                        : count >
                                                                                                                            1320
                                                                                                                          ? "Th√°i ·∫§t Kim Ti√™n"
                                                                                                                          : count >
                                                                                                                              1300
                                                                                                                            ? "Th√°i ·∫§t Ch√¢n Ti√™n"
                                                                                                                            : count >
                                                                                                                                1280
                                                                                                                              ? "Th√°i ·∫§t T√°n Ti√™n"
                                                                                                                              : count >
                                                                                                                                  1260
                                                                                                                                ? "Kim Ti√™n ƒê·ªânh Phong"
                                                                                                                                : count >
                                                                                                                                    1240
                                                                                                                                  ? "Kim Ti√™n H·∫≠u K√¨"
                                                                                                                                  : count >
                                                                                                                                      1220
                                                                                                                                    ? "Kim Ti√™n Trung K√¨"
                                                                                                                                    : count >
                                                                                                                                        1200
                                                                                                                                      ? "Kim Ti√™n S∆° K√¨"
                                                                                                                                      : count >
                                                                                                                                          1180
                                                                                                                                        ? "Thi√™n Ti√™n ƒê·ªânh Phong"
                                                                                                                                        : count >
                                                                                                                                            1160
                                                                                                                                          ? "Thi√™n Ti√™n H·∫≠u K√¨"
                                                                                                                                          : count >
                                                                                                                                              1140
                                                                                                                                            ? "Thi√™n Ti√™n Trung K√¨"
                                                                                                                                            : count >
                                                                                                                                                1120
                                                                                                                                              ? "Thi√™n Ti√™n S∆° K√¨"
                                                                                                                                              : count >
                                                                                                                                                  1100
                                                                                                                                                ? "ƒê·ªãa Ti√™n ƒê·ªânh Phong"
                                                                                                                                                : count >
                                                                                                                                                    1080
                                                                                                                                                  ? "ƒê·ªãa Ti√™n H·∫≠u K√¨"
                                                                                                                                                  : count >
                                                                                                                                                      1060
                                                                                                                                                    ? "ƒê·ªãa Ti√™n Trung K√¨"
                                                                                                                                                    : count >
                                                                                                                                                        1040
                                                                                                                                                      ? "ƒê·ªãa Ti√™n S∆° K√¨"
                                                                                                                                                      : count >
                                                                                                                                                          1020
                                                                                                                                                        ? "Nh√¢n Ti√™n ƒê·ªânh Phong"
                                                                                                                                                        : count >
                                                                                                                                                            1000
                                                                                                                                                          ? "Nh√¢n Ti√™n H·∫≠u K√¨"
                                                                                                                                                          : count >
                                                                                                                                                              980
                                                                                                                                                            ? "Nh√¢n Ti√™n Trung K√¨"
                                                                                                                                                            : count >
                                                                                                                                                                960
                                                                                                                                                              ? "Nh√¢n Ti√™n S∆° K√¨"
                                                                                                                                                              : count >
                                                                                                                                                                  940
                                                                                                                                                                ? "B√°n Ti√™n ƒê·ªânh Phong"
                                                                                                                                                                : count >
                                                                                                                                                                    920
                                                                                                                                                                  ? "B√°n Ti√™n H·∫≠u K√¨"
                                                                                                                                                                  : count >
                                                                                                                                                                      900
                                                                                                                                                                    ? "B√°n Ti√™n Trung K√¨"
                                                                                                                                                                    : count >
                                                                                                                                                                        880
                                                                                                                                                                      ? "B√°n Ti√™n S∆° K√¨"
                                                                                                                                                                      : count >
                                                                                                                                                                          860
                                                                                                                                                                        ? "ƒê·∫°i Th·ª´a C·∫£nh ƒê·ªânh Phong"
                                                                                                                                                                        : count >
                                                                                                                                                                            840
                                                                                                                                                                          ? "ƒê·∫°i Th·ª´a C·∫£nh H·∫≠u K√¨"
                                                                                                                                                                          : count >
                                                                                                                                                                              820
                                                                                                                                                                            ? "ƒê·∫°i Th·ª´a C·∫£nh Trung K√¨"
                                                                                                                                                                            : count >
                                                                                                                                                                                800
                                                                                                                                                                              ? "ƒê·∫°i Th√πa C·∫£nh S∆° K√¨"
                                                                                                                                                                              : count >
                                                                                                                                                                                  780
                                                                                                                                                                                ? "ƒê·ªô Ki·∫øp C·∫£nh ƒê·ªânh Phong"
                                                                                                                                                                                : count >
                                                                                                                                                                                    760
                                                                                                                                                                                  ? "ƒê·ªô Ki·∫øp C·∫£nh H·∫≠u K√¨"
                                                                                                                                                                                  : count >
                                                                                                                                                                                      740
                                                                                                                                                                                    ? "ƒê·ªô Ki·∫øp C·∫£nh Trung K√¨"
                                                                                                                                                                                    : count >
                                                                                                                                                                                        720
                                                                                                                                                                                      ? "ƒê·ªô Ki·∫øp C·∫£nh S∆° K√¨"
                                                                                                                                                                                      : count >
                                                                                                                                                                                          700
                                                                                                                                                                                        ? "H·ª£p Th·ªÉ C·∫£nh ƒê·ªânh Phong"
                                                                                                                                                                                        : count >
                                                                                                                                                                                            680
                                                                                                                                                                                          ? "H·ª£p Th·ªÉ C·∫£nh H·∫≠u K√¨"
                                                                                                                                                                                          : count >
                                                                                                                                                                                              660
                                                                                                                                                                                            ? "H·ª£p Th·ªÉ C·∫£nh Trung K√¨"
                                                                                                                                                                                            : count >
                                                                                                                                                                                                640
                                                                                                                                                                                              ? "H·ª£p Th·ªÉ C·∫£nh S∆° K√¨"
                                                                                                                                                                                              : count >
                                                                                                                                                                                                  620
                                                                                                                                                                                                ? "Luy·ªán H∆∞ C·∫£nh ƒê·ªânh Phong"
                                                                                                                                                                                                : count >
                                                                                                                                                                                                    600
                                                                                                                                                                                                  ? "Luy·ªán H∆∞ C·∫£nh H·∫≠u K√¨"
                                                                                                                                                                                                  : count >
                                                                                                                                                                                                      580
                                                                                                                                                                                                    ? "Luy·ªán H∆∞ C·∫£nh Trung K√¨"
                                                                                                                                                                                                    : count >
                                                                                                                                                                                                        560
                                                                                                                                                                                                      ? "Luy·ªán H∆∞ C·∫£nh S∆° K√¨"
                                                                                                                                                                                                      : count >
                                                                                                                                                                                                          540
                                                                                                                                                                                                        ? "Ho√° Th·∫ßn ƒê·ªânh Phong"
                                                                                                                                                                                                        : count >
                                                                                                                                                                                                            520
                                                                                                                                                                                                          ? "Ho√° Th·∫ßn H·∫≠u K√¨"
                                                                                                                                                                                                          : count >
                                                                                                                                                                                                              500
                                                                                                                                                                                                            ? "Ho√° Th·∫ßn Trung K√¨"
                                                                                                                                                                                                            : count >
                                                                                                                                                                                                                480
                                                                                                                                                                                                              ? "Ho√° Th·∫ßn S∆° K√¨"
                                                                                                                                                                                                              : count >
                                                                                                                                                                                                                  460
                                                                                                                                                                                                                ? "Nguy√™n Anh ƒê·ªânh Phong"
                                                                                                                                                                                                                : count >
                                                                                                                                                                                                                    440
                                                                                                                                                                                                                  ? "Nguy√™n Anh H·∫≠u K√¨"
                                                                                                                                                                                                                  : count >
                                                                                                                                                                                                                      420
                                                                                                                                                                                                                    ? "Nguy√™n Anh Trung K√¨"
                                                                                                                                                                                                                    : count >
                                                                                                                                                                                                                        400
                                                                                                                                                                                                                      ? "Nguy√™n Anh S∆° K√¨"
                                                                                                                                                                                                                      : count >
                                                                                                                                                                                                                          380
                                                                                                                                                                                                                        ? "Kim ƒêan ƒê·ªânh Phong"
                                                                                                                                                                                                                        : count >
                                                                                                                                                                                                                            360
                                                                                                                                                                                                                          ? "Kim ƒêan H·∫≠u K√¨"
                                                                                                                                                                                                                          : count >
                                                                                                                                                                                                                              340
                                                                                                                                                                                                                            ? "Kim ƒêan Trung K√¨"
                                                                                                                                                                                                                            : count >
                                                                                                                                                                                                                                320
                                                                                                                                                                                                                              ? "Kim ƒêan S∆° K√¨"
                                                                                                                                                                                                                              : count >
                                                                                                                                                                                                                                  300
                                                                                                                                                                                                                                ? "Tr√∫c C∆° ƒê·ªânh Phong"
                                                                                                                                                                                                                                : count >
                                                                                                                                                                                                                                    280
                                                                                                                                                                                                                                  ? "Tr√∫c C∆° H·∫≠u K√¨"
                                                                                                                                                                                                                                  : count >
                                                                                                                                                                                                                                      260
                                                                                                                                                                                                                                    ? "Tr√∫c C∆° Trung K√¨"
                                                                                                                                                                                                                                    : count >
                                                                                                                                                                                                                                        240
                                                                                                                                                                                                                                      ? "Tr√∫c C∆° S∆° K√¨"
                                                                                                                                                                                                                                      : count >
                                                                                                                                                                                                                                          220
                                                                                                                                                                                                                                        ? "Luy·ªán Kh√≠ ƒê·ªânh Phong"
                                                                                                                                                                                                                                        : count >
                                                                                                                                                                                                                                            200
                                                                                                                                                                                                                                          ? "Luy·ªán Kh√≠ T·∫ßng Vi√™n M√£n"
                                                                                                                                                                                                                                          : count >
                                                                                                                                                                                                                                              180
                                                                                                                                                                                                                                            ? "Luy·ªán Kh√≠ T·∫ßng 10"
                                                                                                                                                                                                                                            : count >
                                                                                                                                                                                                                                                160
                                                                                                                                                                                                                                              ? "Luy·ªán Kh√≠ T·∫ßng 9"
                                                                                                                                                                                                                                              : count >
                                                                                                                                                                                                                                                  140
                                                                                                                                                                                                                                                ? "Luy·ªán Kh√≠ T·∫ßng 8"
                                                                                                                                                                                                                                                : count >
                                                                                                                                                                                                                                                    120
                                                                                                                                                                                                                                                  ? "Luy·ªán Kh√≠ T·∫ßng 7"
                                                                                                                                                                                                                                                  : count >
                                                                                                                                                                                                                                                      100
                                                                                                                                                                                                                                                    ? "Luy·ªán Kh√≠ T·∫ßng 5"
                                                                                                                                                                                                                                                    : count >
                                                                                                                                                                                                                                                        80
                                                                                                                                                                                                                                                      ? "Luy·ªán Kh√≠ T·∫ßng 4"
                                                                                                                                                                                                                                                      : count >
                                                                                                                                                                                                                                                          60
                                                                                                                                                                                                                                                        ? "Luy·ªán Kh√≠ T·∫ßng 3"
                                                                                                                                                                                                                                                        : count >
                                                                                                                                                                                                                                                            40
                                                                                                                                                                                                                                                          ? "Luy·ªán Kh√≠ T·∫ßng 2"
                                                                                                                                                                                                                                                          : count >
                                                                                                                                                                                                                                                              20
                                                                                                                                                                                                                                                            ? "Luy·ªán Kh√≠ T·∫ßng 1"
                                                                                                                                                                                                                                                            : "ùêçùê°ùêöÃ£ÃÇùê© ùêåùê®ÃÇùêß";
      };

      let smgSorted = "";
      if (res) {
        smgSorted += `‚ôªÔ∏è Nh√≥m: ${threadName}\nüë§ T√™n: ${res.name}\nüéñÔ∏è Ch·ª©c V·ª•: ${position}\nüí¨ T·ªïng Tin Nh·∫Øn: ${res.exp}\nüìä Tu Vi Hi·ªán T·∫°i: ${getRankName(res.exp)}\n\nüìå Th·∫£ c·∫£m x√∫c '‚ù§Ô∏è' tin nh·∫Øn n√†y ƒë·ªÉ xem t·ªïng tin nh·∫Øn c·ªßa to√†n b·ªô th√†nh vi√™n trong nh√≥m`;
      } else {
        smgSorted += "Kh√¥ng c√≥ d·ªØ li·ªáu v·ªÅ t∆∞∆°ng t√°c c·ªßa b·∫°n trong nh√≥m n√†y.";
      }

      api.sendMessage(
        getLang("listInteract", smgSorted),
        event.threadID,
        (err, res) => {
          if (err) {
            console.error("Error:", err);
            return;
          }
          cache.put(
            "message-id",
            {
              messageID: res.messageID,
            },
            5 * 1000 * 60 //5 minutes
          );
        },
        event.messageID
      );
    } catch (error) {
      console.error("Error:", error);
    }
  }
}
